<div (click)="goToDashboard()" class="upper-arrow">
    <span class="material-symbols-outlined">
        arrow_back_ios
    </span>
    <p>Add Helper</p>
</div>

<div class="content-wrapper">
    <div></div>
    <div class="stepper-wrapper">
        <mat-vertical-stepper #stepper [linear]="false">
            <mat-step [stepControl]="profileForm">
                <ng-template matStepLabel>
                    <div class="step-label-wrapper">
                        <div class="step-title">Helper Details</div>
                        <div class="step-description">Add and manage helper info</div>
                    </div>
                </ng-template>
            </mat-step>
            <mat-step [stepControl]="additionalFormGroup">
                <ng-template matStepLabel>
                    <div class="step-label-wrapper">
                        <div class="step-title">Documents</div>
                        <div class="step-description">Upload related documents</div>
                    </div>
                </ng-template>
            </mat-step>
            <mat-step>
                <ng-template matStepLabel>
                    <div class="step-label-wrapper">
                        <div class="step-title">Review</div>
                        <div class="step-description">Check information and confirm</div>
                    </div>
                </ng-template>
            </mat-step>
        </mat-vertical-stepper>
    </div>

    <div class="step-content">
        <ng-container [ngSwitch]="stepper.selectedIndex">
            <form *ngSwitchCase="0" [formGroup]="profileForm">
                <header>
                    <h2>Helper Details</h2>
                    <p style="color: rgb(66, 63, 63);">Track, Add and Manage all your helpers at one place</p>
                </header>
                <div class="form-wrapper">

                    <section class="upload-image-wrapper">
                        <div class="upload-image" (click)="handlePhotoUploadClick($event)">
                            <ng-container *ngIf="imgSrc; else uploadPlaceholder">
                                <img [src]="imgSrc" alt="Profile Preview" class="profile-preview-image">
                            </ng-container>

                            <ng-template #uploadPlaceholder>
                                <span class="material-symbols-outlined">cloud_upload</span>
                                <div class="img-text">Upload Photo</div>
                            </ng-template>
                        </div>
                        <p *ngIf="photoFileName">{{photoFileName}}</p>
                        <input type="file" #photoInput accept=".png,.jpeg,.jpg" (change)="onPhotoSelected($event)"
                            style="display:none;">
                        <p>Upload photo (.png, .jpeg) size 5 MB</p>
                    </section>

                    @for (config of formFieldsConfig(); track config.name) {
                    @if (!config.condition || config.condition(profileForm)) {
                    @switch (config.type) {
                    @case ('select') {
                    <ng-container *ngTemplateOutlet="selectInputTpl; context: {$implicit: config}"></ng-container>
                    }
                    @case ('radio') {
                    <ng-container *ngTemplateOutlet="radioInputTpl; context: {$implicit: config}"></ng-container>
                    }
                    @case ('input') {
                    <ng-container *ngTemplateOutlet="textInputTpl; context: {$implicit: config}"></ng-container>
                    }
                    @case ('conditional-input') {
                    <ng-container *ngTemplateOutlet="conditionalInputTpl; context: {$implicit: config}"></ng-container>
                    }
                    }
                    }
                    }

                    <section class="kyc-wrapper">
                        <p>KYC Document*</p>
                        <div *ngIf="selectedKycFile; else showUploadBox" class="file-preview-card">
                            <span class="material-symbols-outlined file-icon">picture_as_pdf</span>
                            <div class="file-info">
                                <span class="file-name" [title]="selectedKycFile.name">{{ selectedKycFile.name }}</span>
                                <span class="file-size">{{ formatFileSize(selectedKycFile.size) }}</span>
                            </div>
                            <span class="material-symbols-outlined replace-icon"
                                (click)="handleKycUploadClick($event)">refresh</span>
                        </div>
                        <ng-template #showUploadBox>
                            <div class="kyc-upload" (click)="handleKycUploadClick($event)">
                                <span class="material-symbols-outlined">add_2</span>
                            </div>
                        </ng-template>
                        <input type="file" #kycInput accept=".pdf,.jpeg,.jpg,.png" (change)="onKycFileSelected($event)"
                            style="display: none;">
                        <mat-error
                            *ngIf="profileForm.get('kycDoc')?.hasError('required') && profileForm.get('kycDoc')?.touched">
                            This field is mandatory.
                        </mat-error>
                    </section>

                    <div class="btn-wrapper">
                        <button class="btn" type="button" (click)="goToNextStep(stepper,'first')">Next ></button>
                    </div>
                </div>
            </form>

            <form *ngSwitchCase="1" [formGroup]="additionalFormGroup">
                <section class="kyc-wrapper">
                    <p>Additional Documents</p>
                    <div class="kyc-upload">
                        <span class="material-symbols-outlined">add_2</span>
                    </div>
                    <div class="line-wrapper" style="padding-top: 20px;padding-bottom:20px;border:none;">
                        <hr>
                    </div>
                    <div class="btn-wrapper">
                        <button class="btn" type="button" (click)="stepper.previous()">
                            Previous
                        </button>
                        <button class="btn" type="button" (click)="goToNextStep(stepper,'first')">Next ></button>
                    </div>
                </section>
            </form>

            <div *ngSwitchCase="2" class="review-details-container">

                <app-helper-details *ngIf="previewHelper" [selectedHelper]="previewHelper"
                    [kycDoc]="profileForm.get('kycDoc')?.value ?? null">
                </app-helper-details>

                <div class="btn-wrapper">
                    <button class="btn" type="button" (click)="stepper.previous()">Previous</button>
                    <button class="btn" (click)="submitForm()">+ Add Helper</button>
                </div>
            </div>
        </ng-container>
    </div>
</div>


<ng-template #textInputTpl let-config>
    <section class="{{ config.name }}-wrapper">
        <p>{{ config.label }}</p>
        <mat-form-field appearance="outline">
            <input matInput [type]="config.inputType || 'text'" [placeholder]="config.placeholder"
                [formControl]="$any(config.formControl)"
                (keypress)="config.name==='phone'? validateNumber($event):null" />
            @for (err of config.errors ?? []; track err.type) {
            <mat-error *ngIf="config.formControl?.hasError(err.type) && config.formControl?.touched">
                {{ err.message }}
            </mat-error>
            }
        </mat-form-field>
    </section>
</ng-template>

<ng-template #selectInputTpl let-config>
    <section class="{{ config.name }}-wrapper">
        <p>{{ config.label }}</p>
        <mat-form-field appearance="outline">
            <mat-select [formControl]="$any(config.formControl)" [placeholder]="config.placeholder"
                [multiple]="config.isMultiSelect" disableRipple panelClass="service-panel-class">

                @if (config.hasSearch) {
                <mat-option>
                    <label for="searchBox">{{config.searchLabel}}</label>
                    <input id="searchBox" type="text" matInput [placeholder]="config.placeholder"
                        [(ngModel)]="serviceSearch" [ngModelOptions]="{ standalone: true }"
                        (click)="$event.stopPropagation()" />
                </mat-option>
                }
                @for (opt of (config.name === 'serviceType' ? filteredServices() : config.options) ?? []; track opt) {
                <mat-option [value]="opt">{{ opt }}</mat-option>
                }
            </mat-select>

            @for (err of config.errors ?? []; track err.type) {
            <mat-error *ngIf="config.formControl?.hasError(err.type) && config.formControl?.touched">
                {{ err.message }}
            </mat-error>
            }
        </mat-form-field>
    </section>
</ng-template>

<ng-template #radioInputTpl let-config>
    <section class="{{ config.name }}-wrapper">
        <p>{{ config.label }}</p>
        <mat-radio-group [formControl]="$any(config.formControl)">
            @for (opt of config.options ?? []; track opt) {
            <mat-radio-button [value]="opt.toLowerCase()">{{ opt }}</mat-radio-button>
            }
        </mat-radio-group>

        @for (err of config.errors ?? []; track err.type) {
        <mat-error *ngIf="config.formControl?.hasError(err.type) && config.formControl?.touched">
            {{ err.message }}
        </mat-error>
        }
    </section>
</ng-template>

<ng-template #conditionalInputTpl let-config>
    <section class="{{ config.name }}-wrapper">
        <p>{{ config.label }}</p>
        <mat-form-field appearance="outline">
            <input matInput [type]="config.inputType || 'text'" [placeholder]="config.placeholder"
                [formControl]="$any(config.formControl)" />
        </mat-form-field>
    </section>
</ng-template>